<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopnhourBE</title>
    <meta name="color-scheme" content="dark">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body class="splash-page-home make-it-normal">

    <header class="title-bar-container other-bar is-frozen make-it-semi-back make-it-normal grid-container-3c-by-1r-special ">
        <div class="navbar-brand">
            <a class="section" href="/">
                <img class="logo-image" src="/static/shopnhour_blue.png" alt="Shopnhour Store Logo">
            </a>
        </div>
        <div></div>
        <div class="grid-container-3c-by-1r-special make-it-rounded small-section make-it-small">
            <div></div>
            <div class="grid-container-3c-by-1r-special">
                <a class="navbar-item make-it-rounded make-it-dark make-it-8-wide" href="/products">
                    <span><i class="fas fa-box-open small-section"></i>Products</span>
                </a>

                {{#if user}}
                    <div>
                        <a class="navbar-item make-it-rounded make-it-dark make-it-8-wide" href="/current/">
                            <span><i class="fas fa-user small-section"></i>{{user.username}}</span>
                        </a>
                    </div>
                {{else}}
                    <div>
                        <a class="navbar-item make-it-rounded make-it-dark make-it-7-wide" href="/login/">
                            <span><i class="fas fa-key small-section"></i>Log in</span>
                        </a>
                    </div>
                {{/if}}

                <div class="navbar-item make-it-rounded make-it-dark make-it-7-wide cart-container" id="cart-link-container">
                    {{#if user}}
                        <a href="/carts/{{user.cartId}}" id="cart-link">
                            <span><i class="fas fa-shopping-cart small-section"></i> Cart<span id="cart-count" class="cart-count make-it-light-back">0</span></span>
                        </a>
                    {{else}}
                        <a href="/guest-cart" id="cart-link">
                            <span><i class="fas fa-shopping-cart small-section"></i> Cart<span id="cart-count" class="cart-count make-it-light-back">0</span></span>
                        </a>
                    {{/if}}
                </div>

            </div>
        </div>
    </header>

    <main>
        {{{body}}}
    </main>

    <footer class="content section make-it-semi make-it-small">
        <p>&copy; 2025 Shopnhour</p>
    </footer>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const cartCountElement = document.getElementById("cart-count");
            const isLoggedIn = {{#if user}}true{{else}}false{{/if}};
            const userCartId = {{#if user}}"{{user.cartId}}"{{else}}null{{/if}};

            if (isLoggedIn && userCartId) {
                try {
                    const token = localStorage.getItem("token");
                    const res = await fetch(`/api/carts/${userCartId}`, {
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    });
                    if (res.ok) {
                        const result = await res.json();
                        const cart = result.payload;
                        let totalQuantity = 0;
                        if (cart && cart.products && Array.isArray(cart.products)) {
                            totalQuantity = cart.products.reduce((sum, item) => sum + item.quantity, 0);
                        }
                        cartCountElement.textContent = totalQuantity;
                    }
                } catch (err) {
                    console.error("Error fetching cart count", err);
                }
            } else {
                let guestCart = JSON.parse(localStorage.getItem("guestCart") || "[]");
                let totalQuantity = guestCart.reduce((sum, item) => sum + item.quantity, 0);
                cartCountElement.textContent = totalQuantity;
            }
        });
    </script>

</body>
</html>
